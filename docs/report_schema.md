# Report JSON Schema

This reference captures the Phase 5 report writer payload generated by
`crapssim_control`. It supplements the CSV journal/summary docs and is kept in
sync with the controller checkpoints.

⸻

## Top-Level Structure

A report is a JSON object with these primary sections:

- `identity`: Run identifiers merged from spec metadata and CSV config.
- `summary`: Aggregated statistics (events, actions, bankroll snapshots, etc.).
- `memory`: Optional controller memory dumps (engine-agnostic).
- `source_files`: Pointers to CSV, meta, and report artifacts on disk.
- `metadata`: Runtime defaults, validator provenance, and run flag resolution.

⸻

## Example Payload (P1·C5)

```json
{
  "identity": {
    "name": "Quickstart – Place 6/8 with Pass",
    "run_id": "quickstart",
    "seed": 123,
    "timestamp": "2025-10-16T12:00:00Z"
  },
  "summary": {
    "events_total": 120,
    "actions_total": 68,
    "bankroll_final": 1135.5
  },
  "memory": {},
  "source_files": {
    "csv": "journal.csv",
    "meta": "meta.json",
    "report": "report.json"
  },
  "metadata": {
    "demo_fallbacks_default": false,
    "validation_engine": "v1",
    "run_flags": {
      "values": {
        "demo_fallbacks": true,
        "strict": false,
        "embed_analytics": true
      },
      "sources": {
        "demo_fallbacks": "spec",
        "strict": "default",
        "embed_analytics": "default"
      }
    },
    "deprecations": [
      {
        "old": "odds_working_on_comeout",
        "new": "working_on_comeout",
        "action": "migrated"
      }
    ]
  }
}
```

- `metadata.validation_engine` is mandatory and reflects `VALIDATION_ENGINE_VERSION`.
- `metadata.run_flags.values` captures the effective booleans used during the run.
- `metadata.run_flags.sources` records whether each flag came from the default, spec, or CLI overrides.
- `metadata.deprecations` lists any deprecated spec keys that were migrated or
  ignored in favor of canonical names during load.
- `source_files.report` may be omitted when the report is returned in-memory.

⸻

## Versioning

- Schema version tracked implicitly via checkpoint documentation.
- Payload fields remain backward-compatible; new keys are additive.
- Consumers should ignore unknown keys while relying on documented sections.

### Summary (Schema v1.2)

The end-of-run report includes an expanded summary when analytics are enabled:

- `total_hands` (int): Number of hands played.
- `total_rolls` (int): Number of rolls across the session.
- `points_made` (int): Count of established points that were made.
- `pso_count` (int): Point–Seven-Out events (7-out on first roll after establishing a point).
- `bankroll_peak` (number): Highest bankroll observed during the run.
- `bankroll_low` (number): Lowest bankroll observed during the run.
- `max_drawdown` (number): `bankroll_peak - bankroll_min_at_time`.
- `summary_schema_version` (string): `"1.2"`.

> Note: When `run.csv.embed_analytics=false`, `summary_schema_version` is still `"1.2"`, and analytics-derived fields may be zero or omitted depending on configuration.
